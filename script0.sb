#!/bin/bash
########## Define Resources Needed with SBATCH Lines ##########

#SBATCH --time=28:00:00               # limit of wall clock time - how long the job will run (same as -t)
#SBATCH --array=1-600                 # number of jobs being created, each with its array id
#SBATCH --mem=4G                     # memory required per node - amount of memory (in gigs)
#SBATCH --job-name Phylodiversity             # you can give your job a name for easier identification (same as -J)

module load GCC/9.3.0

##################################
# Setup relevant directories
##################################
DATA_DIR=/mnt/home/shahban1/PhylodiversityECDiagnostic/Data

##################################
# Setup random seed info
##################################
PROBLEM_SEED_OFFSET=0
SEED=$((SLURM_ARRAY_TASK_ID + PROBLEM_SEED_OFFSET))

##################################
# Folder naming
##################################
DIAGNOSTIC_1=exploit
DIAGNOSTIC_2=struct_exploit
DIAGNOSTIC_3=diversity
DIAGNOSTIC_4=explore
DIAGNOSTIC_5=weak_diversity

SELECTION_SCHEME_1=tournament
SELECTION_SCHEME_2=fitness_sharing
SELECTION_SCHEME_3=lexicase
SELECTION_SCHEME_4=epsilon_lexicase

###### Treatments #######
TREATMENT__DIAGNOSTIC__1__SELECTION__1__MIN=1
TREATMENT__DIAGNOSTIC__1__SELECTION__1__MAX=30

TREATMENT__DIAGNOSTIC__2__SELECTION__1__MIN=31
TREATMENT__DIAGNOSTIC__2__SELECTION__1__MAX=60

TREATMENT__DIAGNOSTIC__3__SELECTION__1__MIN=61
TREATMENT__DIAGNOSTIC__3__SELECTION__1__MAX=90

TREATMENT__DIAGNOSTIC__4__SELECTION__1__MIN=91
TREATMENT__DIAGNOSTIC__4__SELECTION__1__MAX=120

TREATMENT__DIAGNOSTIC__5__SELECTION__1__MIN=121
TREATMENT__DIAGNOSTIC__5__SELECTION__1__MAX=150

TREATMENT__DIAGNOSTIC__1__SELECTION__2__MIN=151
TREATMENT__DIAGNOSTIC__1__SELECTION__2__MAX=180

TREATMENT__DIAGNOSTIC__2__SELECTION__2__MIN=181
TREATMENT__DIAGNOSTIC__2__SELECTION__2__MAX=210

TREATMENT__DIAGNOSTIC__3__SELECTION__2__MIN=211
TREATMENT__DIAGNOSTIC__3__SELECTION__2__MAX=240

TREATMENT__DIAGNOSTIC__4__SELECTION__2__MIN=241
TREATMENT__DIAGNOSTIC__4__SELECTION__2__MAX=270

TREATMENT__DIAGNOSTIC__5__SELECTION__2__MIN=271
TREATMENT__DIAGNOSTIC__5__SELECTION__2__MAX=300

TREATMENT__DIAGNOSTIC__1__SELECTION__3__MIN=301
TREATMENT__DIAGNOSTIC__1__SELECTION__3__MAX=330

TREATMENT__DIAGNOSTIC__2__SELECTION__3__MIN=331
TREATMENT__DIAGNOSTIC__2__SELECTION__3__MAX=360

TREATMENT__DIAGNOSTIC__3__SELECTION__3__MIN=361
TREATMENT__DIAGNOSTIC__3__SELECTION__3__MAX=390

TREATMENT__DIAGNOSTIC__4__SELECTION__3__MIN=391
TREATMENT__DIAGNOSTIC__4__SELECTION__3__MAX=420

TREATMENT__DIAGNOSTIC__5__SELECTION__3__MIN=421
TREATMENT__DIAGNOSTIC__5__SELECTION__3__MAX=450

TREATMENT__DIAGNOSTIC__1__SELECTION__4__MIN=451
TREATMENT__DIAGNOSTIC__1__SELECTION__4__MAX=480

TREATMENT__DIAGNOSTIC__2__SELECTION__4__MIN=481
TREATMENT__DIAGNOSTIC__2__SELECTION__4__MAX=510

TREATMENT__DIAGNOSTIC__3__SELECTION__4__MIN=511
TREATMENT__DIAGNOSTIC__3__SELECTION__4__MAX=540

TREATMENT__DIAGNOSTIC__4__SELECTION__4__MIN=541
TREATMENT__DIAGNOSTIC__4__SELECTION__4__MAX=570

TREATMENT__DIAGNOSTIC__5__SELECTION__4__MIN=571
TREATMENT__DIAGNOSTIC__5__SELECTION__4__MAX=600


##################################
# Config file parameters
##################################
OBJECTIVE_CNT=100
GENERATIONS=20000

####################################################################

if [ ${SLURM_ARRAY_TASK_ID} -ge ${TREATMENT__DIAGNOSTIC__1__SELECTION__1__MIN} ] && [ ${SLURM_ARRAY_TASK_ID} -le ${TREATMENT__DIAGNOSTIC__1__SELECTION__1__MAX} ] ; then
  NAME=DIA_${DIAGNOSTIC_1}__SEED_${SEED}
  DIAGNOSTIC=0
  SELECTION_SCHEME=0
  MABE_FILE=../config/PhylodiversityDiagnostics.mabe

elif [ ${SLURM_ARRAY_TASK_ID} -ge ${TREATMENT__DIAGNOSTIC__2__SELECTION__1__MIN} ] && [ ${SLURM_ARRAY_TASK_ID} -le ${TREATMENT__DIAGNOSTIC__2__SELECTION__1__MAX} ] ; then
  NAME=DIA_${DIAGNOSTIC_2}__SEED_${SEED}
  DIAGNOSTIC=1
  SELECTION_SCHEME=0
  MABE_FILE=../config/PhylodiversityDiagnostics.mabe

elif [ ${SLURM_ARRAY_TASK_ID} -ge ${TREATMENT__DIAGNOSTIC__3__SELECTION__1__MIN} ] && [ ${SLURM_ARRAY_TASK_ID} -le ${TREATMENT__DIAGNOSTIC__3__SELECTION__1__MAX} ] ; then
  NAME=DIA_${DIAGNOSTIC_3}__SEED_${SEED}
  DIAGNOSTIC=2
  SELECTION_SCHEME=0
  MABE_FILE=../config/PhylodiversityDiagnostics.mabe

elif [ ${SLURM_ARRAY_TASK_ID} -ge ${TREATMENT__DIAGNOSTIC__4__SELECTION__1__MIN} ] && [ ${SLURM_ARRAY_TASK_ID} -le ${TREATMENT__DIAGNOSTIC__4__SELECTION__1__MAX} ] ; then
  NAME=DIA_${DIAGNOSTIC_4}__SEED_${SEED}
  DIAGNOSTIC=3
  SELECTION_SCHEME=0
  MABE_FILE=../config/PhylodiversityDiagnostics.mabe

elif [ ${SLURM_ARRAY_TASK_ID} -ge ${TREATMENT__DIAGNOSTIC__5__SELECTION__1__MIN} ] && [ ${SLURM_ARRAY_TASK_ID} -le ${TREATMENT__DIAGNOSTIC__5__SELECTION__1__MAX} ] ; then
  NAME=DIA_${DIAGNOSTIC_5}__SEED_${SEED}
  DIAGNOSTIC=4
  SELECTION_SCHEME=0
  MABE_FILE=../config/PhylodiversityDiagnostics.mabe

elif [ ${SLURM_ARRAY_TASK_ID} -ge ${TREATMENT__DIAGNOSTIC__1__SELECTION__2__MIN} ] && [ ${SLURM_ARRAY_TASK_ID} -le ${TREATMENT__DIAGNOSTIC__1__SELECTION__2__MAX} ] ; then
  NAME=DIA_${DIAGNOSTIC_1}__SEED_${SEED}
  DIAGNOSTIC=0
  SELECTION_SCHEME=1
  MABE_FILE=../config/PhylodiversityDiagnostics.mabe

elif [ ${SLURM_ARRAY_TASK_ID} -ge ${TREATMENT__DIAGNOSTIC__2__SELECTION__2__MIN} ] && [ ${SLURM_ARRAY_TASK_ID} -le ${TREATMENT__DIAGNOSTIC__2__SELECTION__2__MAX} ] ; then
  NAME=DIA_${DIAGNOSTIC_2}__SEED_${SEED}
  DIAGNOSTIC=1
  SELECTION_SCHEME=1
  MABE_FILE=../config/PhylodiversityDiagnostics.mabe

elif [ ${SLURM_ARRAY_TASK_ID} -ge ${TREATMENT__DIAGNOSTIC__3__SELECTION__2__MIN} ] && [ ${SLURM_ARRAY_TASK_ID} -le ${TREATMENT__DIAGNOSTIC__3__SELECTION__2__MAX} ] ; then
  NAME=DIA_${DIAGNOSTIC_3}__SEED_${SEED}
  DIAGNOSTIC=2
  SELECTION_SCHEME=1
  MABE_FILE=../config/PhylodiversityDiagnostics.mabe

elif [ ${SLURM_ARRAY_TASK_ID} -ge ${TREATMENT__DIAGNOSTIC__4__SELECTION__2__MIN} ] && [ ${SLURM_ARRAY_TASK_ID} -le ${TREATMENT__DIAGNOSTIC__4__SELECTION__2__MAX} ] ; then
  NAME=DIA_${DIAGNOSTIC_4}__SEED_${SEED}
  DIAGNOSTIC=3
  SELECTION_SCHEME=1
  MABE_FILE=../config/PhylodiversityDiagnostics.mabe

elif [ ${SLURM_ARRAY_TASK_ID} -ge ${TREATMENT__DIAGNOSTIC__5__SELECTION__2__MIN} ] && [ ${SLURM_ARRAY_TASK_ID} -le ${TREATMENT__DIAGNOSTIC__5__SELECTION__2__MAX} ] ; then
  NAME=DIA_${DIAGNOSTIC_5}__SEED_${SEED}
  DIAGNOSTIC=4
  SELECTION_SCHEME=1 
  MABE_FILE=../config/PhylodiversityDiagnostics.mabe

elif [ ${SLURM_ARRAY_TASK_ID} -ge ${TREATMENT__DIAGNOSTIC__1__SELECTION__3__MIN} ] && [ ${SLURM_ARRAY_TASK_ID} -le ${TREATMENT__DIAGNOSTIC__1__SELECTION__3__MAX} ] ; then
  NAME=DIA_${DIAGNOSTIC_1}__SEED_${SEED}
  DIAGNOSTIC=0
  SELECTION_SCHEME=2
  MABE_FILE=../config/PhylodiversityDiagnostics.mabe

elif [ ${SLURM_ARRAY_TASK_ID} -ge ${TREATMENT__DIAGNOSTIC__2__SELECTION__3__MIN} ] && [ ${SLURM_ARRAY_TASK_ID} -le ${TREATMENT__DIAGNOSTIC__2__SELECTION__3__MAX} ] ; then
  NAME=DIA_${DIAGNOSTIC_2}__SEED_${SEED}
  DIAGNOSTIC=1
  SELECTION_SCHEME=2
  MABE_FILE=../config/PhylodiversityDiagnostics.mabe

elif [ ${SLURM_ARRAY_TASK_ID} -ge ${TREATMENT__DIAGNOSTIC__3__SELECTION__3__MIN} ] && [ ${SLURM_ARRAY_TASK_ID} -le ${TREATMENT__DIAGNOSTIC__3__SELECTION__3__MAX} ] ; then
  NAME=DIA_${DIAGNOSTIC_3}__SEED_${SEED}
  DIAGNOSTIC=2
  SELECTION_SCHEME=2
  MABE_FILE=../config/PhylodiversityDiagnostics.mabe

elif [ ${SLURM_ARRAY_TASK_ID} -ge ${TREATMENT__DIAGNOSTIC__4__SELECTION__3__MIN} ] && [ ${SLURM_ARRAY_TASK_ID} -le ${TREATMENT__DIAGNOSTIC__4__SELECTION__3__MAX} ] ; then
  NAME=DIA_${DIAGNOSTIC_4}__SEED_${SEED}
  DIAGNOSTIC=3
  SELECTION_SCHEME=2
  MABE_FILE=../config/PhylodiversityDiagnostics.mabe

elif [ ${SLURM_ARRAY_TASK_ID} -ge ${TREATMENT__DIAGNOSTIC__5__SELECTION__3__MIN} ] && [ ${SLURM_ARRAY_TASK_ID} -le ${TREATMENT__DIAGNOSTIC__5__SELECTION__3__MAX} ] ; then
  NAME=DIA_${DIAGNOSTIC_5}__SEED_${SEED}
  DIAGNOSTIC=4
  SELECTION_SCHEME=2
  MABE_FILE=../config/PhylodiversityDiagnostics.mabe
  
elif [ ${SLURM_ARRAY_TASK_ID} -ge ${TREATMENT__DIAGNOSTIC__1__SELECTION__4__MIN} ] && [ ${SLURM_ARRAY_TASK_ID} -le ${TREATMENT__DIAGNOSTIC__1__SELECTION__4__MAX} ] ; then
  NAME=DIA_${DIAGNOSTIC_1}__SEED_${SEED}
  DIAGNOSTIC=0
  SELECTION_SCHEME=3
  MABE_FILE=../config/PhylodiversityDiagnostics.mabe

elif [ ${SLURM_ARRAY_TASK_ID} -ge ${TREATMENT__DIAGNOSTIC__2__SELECTION__4__MIN} ] && [ ${SLURM_ARRAY_TASK_ID} -le ${TREATMENT__DIAGNOSTIC__2__SELECTION__4__MAX} ] ; then
  NAME=DIA_${DIAGNOSTIC_2}__SEED_${SEED}
  DIAGNOSTIC=1
  SELECTION_SCHEME=3
  MABE_FILE=../config/PhylodiversityDiagnostics.mabe

elif [ ${SLURM_ARRAY_TASK_ID} -ge ${TREATMENT__DIAGNOSTIC__3__SELECTION__4__MIN} ] && [ ${SLURM_ARRAY_TASK_ID} -le ${TREATMENT__DIAGNOSTIC__3__SELECTION__4__MAX} ] ; then
  NAME=DIA_${DIAGNOSTIC_3}__SEED_${SEED}
  DIAGNOSTIC=2
  SELECTION_SCHEME=3
  MABE_FILE=../config/PhylodiversityDiagnostics.mabe

elif [ ${SLURM_ARRAY_TASK_ID} -ge ${TREATMENT__DIAGNOSTIC__4__SELECTION__4__MIN} ] && [ ${SLURM_ARRAY_TASK_ID} -le ${TREATMENT__DIAGNOSTIC__4__SELECTION__4__MAX} ] ; then
  NAME=DIA_${DIAGNOSTIC_4}__SEED_${SEED}
  DIAGNOSTIC=3
  SELECTION_SCHEME=3
  MABE_FILE=../config/PhylodiversityDiagnostics.mabe

elif [ ${SLURM_ARRAY_TASK_ID} -ge ${TREATMENT__DIAGNOSTIC__5__SELECTION__4__MIN} ] && [ ${SLURM_ARRAY_TASK_ID} -le ${TREATMENT__DIAGNOSTIC__5__SELECTION__4__MAX} ] ; then
  NAME=DIA_${DIAGNOSTIC_5}__SEED_${SEED}
  DIAGNOSTIC=4
  SELECTION_SCHEME=3
  MABE_FILE=../config/PhylodiversityDiagnostics.mabe

else
  echo "${SEED} from ${PROBLEM} failed to launch" >> /mnt/gs18/scratch/users/shahban1/ps-coh-failtolaunch.txt
fi

####################################################################

RUN_DIR=${DATA_DIR}/DIAGNOSTIC_${DIAGNOSTIC}_SELECTION_${SELECTION_SCHEME}/${NAME}/

# make a run directory
mkdir ${DATA_DIR}/DIAGNOSTIC_${DIAGNOSTIC}_SELECTION_${SELECTION_SCHEME}
mkdir -p ${RUN_DIR}

echo "../../MABE2/build/MABE -f ${MABE_FILE} --set random_seed=${SEED} --set diagnostic=${DIAGNOSTIC} --set fit_file.filename=\\\"${RUN_DIR}/output.csv\\\" --set sys.snapshot_file_root_name=\\\"${RUN_DIR}/phylogeny\\\" --set sys.data_file_name=\\\"${RUN_DIR}/phylogenetic_data.csv\\\" --set selection_type=${SELECTION_SCHEME}> run.log" > ./cmd-coh.txt

../../MABE2/build/MABE -f ${MABE_FILE} --set random_seed=${SEED} --set diagnostic=${DIAGNOSTIC} --set fit_file.filename=\"${RUN_DIR}/output.csv\" --set sys.snapshot_file_root_name=\"${RUN_DIR}/phylogeny\" --set sys.data_file_name=\"${RUN_DIR}/phylogenetic_data.csv\" --set selection_type=${SELECTION_SCHEME}> ${RUN_DIR}/run.log